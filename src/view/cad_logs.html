<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Logs - DevHub</title>
    <link rel="stylesheet" href="../style/style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css">
</head>
<body>

    <script>
        const usuarioLogado = localStorage.getItem('usuarioLogado');
        if (!usuarioLogado) {
            alert("Você não está logado. Redirecionando para a tela de cadastro/login.");
            window.location.href = 'cad_usuario.html'; 
        }
        const usuario = JSON.parse(usuarioLogado);
    </script>

    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="index.html">DevHub - Cadastro de Log</a>
            <a href="index.html" class="btn btn-sm btn-secondary ms-auto">Cancelar e Voltar</a>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="mb-4 text-center">Cadastro de Logs</h1>
        
        <form id="frmCadLogs">
            <h3 class="text-center mb-4">Registrar Progresso</h3>

            <div class="mb-3">
                <label for="inputCategoria" class="form-label">Categoria</label>
                <select class="form-select" id="inputCategoria" required>
                    <option value="">Selecione uma Categoria</option>
                    <option value="Programacao">Programação</option>
                    <option value="Arte 3D/2D">Arte 3D/2D</option>
                    <option value="Sound Design">Sound Design</option>
                    <option value="Design de Nível">Design de Nível</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="inputTitulo" class="form-label">Título do Log</label>
                <input type="text" class="form-control" id="inputTitulo" required>
            </div>
            
            <div class="mb-3">
                <label for="inputDescricao" class="form-label">Descrição Detalhada do Trabalho</label>
                <textarea class="form-control" id="inputDescricao" rows="3" required></textarea>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="inputHoras" class="form-label">Horas Trabalhadas</label>
                    <input type="number" class="form-control" id="inputHoras" min="0" step="0.5" value="0">
                </div>
                <div class="col-md-4">
                    <label for="inputLinhas" class="form-label">Linhas de Código</label>
                    <input type="number" class="form-control" id="inputLinhas" min="0" value="0">
                </div>
                <div class="col-md-4">
                    <label for="inputBugs" class="form-label">Bugs Corrigidos</label>
                    <input type="number" class="form-control" id="inputBugs" min="0" value="0">
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100">Cadastrar Log</button>
            <div id="mensagem" class="mt-3 text-center small"></div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('frmCadLogs').addEventListener('submit', async (e) => {
            e.preventDefault();

            const mensagemDiv = document.getElementById('mensagem');
            const btnSubmit = e.target.querySelector('button[type="submit"]');

            // 1. Coleta dos dados do formulário
            const dadosLog = {
                titulo: document.getElementById('inputTitulo').value,
                categoria: document.getElementById('inputCategoria').value,
                descricao_do_trabalho: document.getElementById('inputDescricao').value,
                horas_trabalhadas: parseFloat(document.getElementById('inputHoras').value) || 0,
                linhas_codigo: parseInt(document.getElementById('inputLinhas').value) || 0,
                bugs_corrigidos: parseInt(document.getElementById('inputBugs').value) || 0,
                // O ID do usuário logado é ESSENCIAL para vincular o log
                id_user: usuario.id 
            };

            // 2. Trava o botão para evitar cliques duplos
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Enviando...';
            mensagemDiv.className = 'mt-3 text-center small text-info';
            mensagemDiv.textContent = 'Processando o registro do seu log...';

            try {
                // 3. Envio dos dados para a API (POST /logs)
                const response = await fetch('http://localhost:3000/logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosLog)
                });

                if (response.ok) {
                    // Log cadastrado com sucesso (201 Created)
                    mensagemDiv.className = 'mt-3 text-center small text-success';
                    mensagemDiv.textContent = 'Log cadastrado com sucesso! Redirecionando...';
                    
                    // 4. REDIRECIONAMENTO PARA A PÁGINA INICIAL
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500); 

                } else {
                    // Erro ao cadastrar (ex: 400 Bad Request, 500 Internal Server Error)
                    const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                    throw new Error(errorData.error || `Falha no servidor: ${response.status}`);
                }
            } catch (error) {
                console.error("Erro ao cadastrar log:", error);
                mensagemDiv.className = 'mt-3 text-center small text-danger';
                mensagemDiv.textContent = `Falha no cadastro: ${error.message}.`;
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Cadastrar Log';
            }
        });
    </script>
</body>
</html>