<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Log - DevHub</title>
    <link rel="stylesheet" href="../style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div class="container mt-5">
        <h1 class="mb-4 text-center">Registrar Novo Log</h1>
        
        <form id="frmCadLog">
            <h3 class="text-center mb-4">Detalhes do Log</h3>

            <div class="mb-3">
                <label for="inputData" class="form-label">Data do Log</label>
                <input type="date" class="form-control" id="inputData" required>
            </div>
            
            <div class="mb-3">
                <label for="inputHoras" class="form-label">Horas Trabalhadas (em horas)</label>
                <input type="number" class="form-control" id="inputHoras" step="0.1" min="0.1" required>
            </div>

            <div class="mb-3">
                <label for="inputDescricao" class="form-label">Descrição do Trabalho</label>
                <textarea class="form-control" id="inputDescricao" rows="3" required></textarea>
            </div>
            
            <button type="submit" class="btn btn-success w-100">Registrar Log</button>

            <p class="text-center mt-3 small">
                <a href="index.html">Voltar para o Dashboard</a>.
            </p>
            
            <div id="mensagemLog" class="mt-3 text-center small"></div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
    <script>
        // CORREÇÃO: Variável 'usuario' deve ser definida e verificada
        const usuarioData = sessionStorage.getItem("usuario");
        
        // 1. VERIFICAÇÃO DE LOGIN E CORREÇÃO DO 'usuario is not defined'
        if (!usuarioData) {
            alert('Você precisa estar logado para registrar um log. Redirecionando...');
            window.location.href = 'login.html';
        }

        let usuario;
        try {
            usuario = JSON.parse(usuarioData);
        } catch (e) {
            // Se o JSON estiver inválido ou vazio
            alert('Erro nos dados de usuário. Faça login novamente.');
            window.location.href = 'login.html';
        }

        // Se o objeto usuário for válido, mas não tiver o ID
        if (!usuario || !usuario.id) {
            alert('Dados de usuário incompletos. Faça login novamente.');
            window.location.href = 'login.html';
        }

        document.getElementById('frmCadLog').addEventListener('submit', async (e) => {
            e.preventDefault();

            const mensagemDiv = document.getElementById('mensagemLog');
            const btnSubmit = e.target.querySelector('button[type="submit"]');

            // 2. Coleta dos dados do formulário
            const dadosLog = {
                data_log: document.getElementById('inputData').value,
                horas_trabalhadas: parseFloat(document.getElementById('inputHoras').value),
                descricao: document.getElementById('inputDescricao').value,
                // CHAVE CRÍTICA: ID do usuário logado
                id_usuario: usuario.id 
            };

            // 3. Trava o botão e exibe mensagem
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Enviando...';
            mensagemDiv.className = 'mt-3 text-center small text-info';
            mensagemDiv.textContent = 'Registrando log no servidor...';

            try {
                // Rota que deve estar no seu app.js
                const response = await fetch('http://localhost:3000/logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosLog)
                });

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    data = { message: response.statusText };
                }

                if (response.ok) {
                    // Log de sucesso
                    mensagemDiv.className = 'mt-3 text-center small text-success';
                    mensagemDiv.textContent = 'Log registrado com sucesso!';
                    
                    // Limpa o formulário após o sucesso
                    e.target.reset();
                    
                } else {
                    // Erro de servidor (ex: 500)
                    mensagemDiv.className = 'mt-3 text-center small text-danger';
                    mensagemDiv.textContent = `Falha no registro: ${data.message || `Erro desconhecido. Status: ${response.status}`}.`;
                }

            } catch (error) {
                console.error("Erro ao registrar log:", error);
                mensagemDiv.className = 'mt-3 text-center small text-danger';
                mensagemDiv.textContent = `Falha na conexão: ${error.message}. Verifique se o Node.js está rodando.`;
            } finally {
                // 5. Destrava o botão
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Registrar Log';
            }
        });
    </script>
</body>
</html>