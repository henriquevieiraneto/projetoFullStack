<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevHub - Dashboard</title>
    <link rel="stylesheet" href="../style/style.css"> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css">
    <style>
        /* Estilos menores para o layout */
        body { background-color: #f4f4f4; }
        .log-card { border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px; background-color: white; } 
        .log-metrics-detail { display: flex; gap: 15px; font-size: 0.85em; margin-bottom: 10px; }
        .log-metrics-detail span { color: #6c757d; } 
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background-color: #ced4da; }
        .log-header { display: flex; align-items: center; margin-bottom: 10px; }
        .main-container { padding-top: 20px; }
        .sidebar { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <script>
        const usuarioLogado = localStorage.getItem('usuarioLogado');
        if (!usuarioLogado) {
            // Se n√£o houver dados, redireciona para a tela de login
            alert("Voc√™ n√£o est√° logado. Redirecionando para o login.");
            window.location.href = 'login.html'; 
        }
        const usuario = JSON.parse(usuarioLogado);
    </script>

    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="index.html">DevHub</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" href="index.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="lista_logs.html">Comunidade Logs</a></li>
                    <li class="nav-item"><a class="nav-link" href="metricas_usuario.html">M√©tricas Detalhadas</a></li>
                </ul>
                <button class="btn btn-sm btn-outline-danger" id="btnLogout">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <div class="row">
            
            <div class="col-md-3">
                <div class="sidebar">
                    <h5 id="usuarioNome" class="fw-bold"></h5>
                    <p class="text-muted small">Game Developer</p>
                    <hr>
                    
                    <h6>M√©tricas Pessoais</h6>
                    <p class="small mb-1">Qtd. Logs: <span id="qtd-logs" class="fw-bold text-primary">0</span></p>
                    <p class="small mb-1">Total de Bugs: <span id="total-bugs" class="fw-bold text-danger">0</span></p>
                    <p class="small mb-4">Horas Trabalhadas: <span id="total-horas" class="fw-bold text-success">0h</span></p>

                    <h6 class="mt-4">Filtros de Categoria</h6>
                    <div id="filtro-area">
                        <div class="form-check small">
                            <input class="form-check-input" type="checkbox" value="Programacao" id="filterProgramacao">
                            <label class="form-check-label" for="filterProgramacao">Programa√ß√£o</label>
                        </div>
                        <div class="form-check small">
                            <input class="form-check-input" type="checkbox" value="Arte 3D/2D" id="filterArte">
                            <label class="form-check-label" for="filterArte">Arte 3D/2D</label>
                        </div>
                        <div class="form-check small">
                            <input class="form-check-input" type="checkbox" value="Sound Design" id="filterSound">
                            <label class="form-check-label" for="filterSound">Sound Design</label>
                        </div>
                        <div class="form-check small">
                            <input class="form-check-input" type="checkbox" value="Design de N√≠vel" id="filterDesign">
                            <label class="form-check-label" for="filterDesign">Design de N√≠vel</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <a href="cad_logs.html" class="btn btn-primary mb-3">
                    + Criar Novo Log
                </a>
                
                <div id="logs-feed">
                    <p class="alert alert-info">Carregando logs...</p>
                </div>
            </div>

            <div class="col-md-3">
                <div class="sidebar">
                    <h6>Atividade Recente</h6>
                    <ul class="list-unstyled small text-muted">
                        <li>Maria Santos criou um novo log</li>
                        <li>Carlos Lima editou um log</li>
                    </ul>
                    
                    <h6 class="mt-3">Desenvolvedores em Destaque</h6>
                    <ul class="list-unstyled small text-muted">
                        <li>Roberto Tech</li>
                        <li>Sofia Arts</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
    <script>
        
        // A vari√°vel 'usuario' j√° cont√©m os dados do usu√°rio logado (nome, id, etc.)
        
        // 1. LOGOUT
        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('usuarioLogado'); // Limpa a sess√£o
            window.location.href = 'login.html'; // Redireciona para o login
        });
        
        // 2. FUN√á√ÉO PARA CARREGAR AS M√âTRICAS DO USU√ÅRIO NA SIDEBAR
        async function carregarMetricas(userId) {
            const url = `http://localhost:3000/metricas-usuario/${userId}`;
            try {
                const response = await fetch(url);
                const metricas = await response.json();
                
                // CORRE√á√ÉO APLICADA: Usa parseFloat() para garantir que o valor √© um n√∫mero antes de chamar .toFixed()
                const horas = parseFloat(metricas.horas_trabalhadas) || 0; 

                document.getElementById('qtd-logs').textContent = metricas.total_logs || 0;
                document.getElementById('total-bugs').textContent = metricas.bugs_corrigidos || 0;
                document.getElementById('total-horas').textContent = `${horas.toFixed(1)}h`; 

            } catch (error) {
                // Se falhar na conex√£o, este erro de m√©tricas n√£o impede o carregamento do feed.
                console.error("Erro ao carregar m√©tricas:", error);
                // NOTA: Os dados mostrados na imagem (2 logs, 50011 bugs) parecem vir de um cache local
                // ou de uma falha parcial, pois o toFixed() falha depois.
            }
        }
        
        // 3. FUN√á√ÉO PARA DAR/RETIRAR LIKE
        async function toggleLike(logId, userId) {
            const url = "http://localhost:3000/likes";
            
            try {
                let response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id_log: logId, id_user: userId })
                });

                if (response.status === 201) {
                    carregarLogs(getCurrentFilters()); 
                    return;
                } 
                
                if (response.status === 409) {
                    response = await fetch(`${url}?id_log=${logId}&id_user=${userId}`, {
                        method: "DELETE"
                    });

                    if (response.ok) {
                        carregarLogs(getCurrentFilters()); 
                        return;
                    } 
                    
                    throw new Error(`Falha ao retirar like: Status ${response.status}`);
                }

                throw new Error(`Falha na opera√ß√£o: Status ${response.status}`);

            } catch (error) {
                console.error("Erro na opera√ß√£o de like/deslike: ", error);
                alert(`Erro: ${error.message}`);
            }
        }

        // 4. ADICIONA EVENT LISTENER NOS BOT√ïES DE LIKE
        function adicionarListenersLike() {
            const userId = usuario.id;
            document.querySelectorAll('.btn-like').forEach(button => {
                button.addEventListener('click', function() {
                    const logId = parseInt(this.getAttribute('data-log-id'));
                    if (logId && userId) {
                        toggleLike(logId, userId);
                    } else {
                        alert("Erro: ID do Log ou ID do Usu√°rio ausente.");
                    }
                });
            });
        }
        
        // 5. FUN√á√ÉO AUXILIAR PARA OBTER OS FILTROS ATUAIS
        function getCurrentFilters() {
            const checkboxes = document.querySelectorAll('#filtro-area input[type="checkbox"]:checked');
            // Retorna apenas o primeiro filtro para a rota simples que configuramos
            return Array.from(checkboxes).map(cb => cb.value); 
        }

        // 6. FUN√á√ÉO PRINCIPAL PARA CARREGAR O FEED DE LOGS (com filtros)
        async function carregarLogs(filtros = []) {
            const logsFeed = document.getElementById('logs-feed');
            logsFeed.innerHTML = '<p class="alert alert-info">Carregando logs...</p>';

            let url = "http://localhost:3000/logs?pagina=1&quantidade=10"; 
            
            if (filtros.length > 0) {
                url += `&categoria=${encodeURIComponent(filtros[0])}`; 
            }
            
            try {
                const response = await fetch(url);
                
                // Se houver falha de conex√£o ou 500, cai no catch ou no if(response.ok)
                if (!response.ok) {
                     throw new Error('Falha na conex√£o com o servidor Node.js ou erro interno.');
                }

                const logs = await response.json();
                
                logsFeed.innerHTML = ''; 

                if (logs.length === 0) {
                    logsFeed.innerHTML = '<div class="alert alert-info">Nenhum log encontrado. Ajuste seus filtros ou crie um!</div>';
                    return;
                }

                logs.forEach(log => {
                    // CORRE√á√ÉO APLICADA: Garante que o valor √© um n√∫mero antes de chamar toFixed()
                    const horasLog = parseFloat(log.horas_trabalhadas) || 0;

                    const logElement = document.createElement('div');
                    logElement.className = 'log-card';
                    logElement.innerHTML = `
                        <div class="log-header">
                            <div class="user-avatar" style="background-color: #ced4da;"></div>
                            <div>
                                <h6 class="mb-0 fw-bold">${log.usuario_nome || 'Usu√°rio Desconhecido'}</h6>
                                <span class="small text-muted">${new Date(log.data_registro).toLocaleDateString()}</span>
                            </div>
                        </div>
                        
                        <h5 class="mt-2 mb-1">${log.titulo || 'Log Sem T√≠tulo'} 
                            <span class="badge bg-primary ms-2">${log.categoria}</span>
                        </h5>
                        
                        <p class="small">${log.descricao_do_trabalho || 'Nenhuma descri√ß√£o fornecida.'}</p>
                        
                        <div class="log-metrics-detail">
                            <span>üïí ${horasLog.toFixed(1)}h</span>
                            <span>‚úçÔ∏è ${log.linhas_codigo || 0} linhas</span>
                            <span>üêõ ${log.bugs_corrigidos || 0} bugs corrigidos</span>
                        </div>
                        
                        <div class="log-actions mt-2">
                            <button class="btn btn-sm btn-link text-danger p-0 btn-like" data-log-id="${log.id}">
                                ‚ù§Ô∏è ${log.likes_count || 0}
                            </button> 
                            <button class="btn btn-sm btn-link p-0">
                                üí¨ 0 coment√°rios
                            </button>
                            <input type="text" class="form-control form-control-sm ms-auto" placeholder="Escreva um coment√°rio...">
                        </div>
                    `;
                    logsFeed.appendChild(logElement);
                });

                adicionarListenersLike(); 
                
            } catch (error) {
                console.error("Erro ao carregar logs:", error);
                logsFeed.innerHTML = '<div class="alert alert-danger">Falha ao carregar o feed. Verifique se o servidor est√° rodando.</div>';
            }
        }
        
        // 7. FUN√á√ÉO PARA APLICAR FILTROS
        function aplicarFiltros() {
            const filtros = getCurrentFilters();
            carregarLogs(filtros);
        }

        // 8. CHAMA AS FUN√á√ïES AO CARREGAR A P√ÅGINA
        document.addEventListener('DOMContentLoaded', () => {
            // Injeta o nome do usu√°rio logado
            document.getElementById('usuarioNome').textContent = usuario.nome;

            const userId = usuario.id; 
            
            // AQUI S√ÉO CHAMADAS AS FUN√á√ïES
            carregarMetricas(userId); 
            carregarLogs();
            
            // Adiciona listeners para acionar a filtragem
            document.querySelectorAll('#filtro-area input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', aplicarFiltros);
            });
        });

    </script>
</body>
</html>